<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.pineapple.invest.service.InvestMapper">
	 <!-- InvestAndFd -->
	 <resultMap type="com.pineapple.invest.service.InvestAndFd"
	 			id="selectInvestAndFd">
	 	<result property="fdCode" column="fdCode"/>
	 	<result property="fdTitle" column="fdTitle"/>
	 	<result property="numberOfShares" column="numberOfShares"/>
	 	<result property="comName" column="comName"/>
	 	<result property="total" column="total"/>
	 	<result property="posterImg" column="posterImg"/>
	 	<result property="minInvestMoney" column="minInvestMoney"/>
	 	<result property="issuePrice" column="issuePrice"/>
	 	<result property="days" column="days"/>
	 	<result property="fdStatus" column="fdStatus"/>
	 </resultMap>
	 <!-- InvestAndFdLikeAndFd -->
	 <resultMap type="com.pineapple.invest.service.InvestAndFdLikeAndFd"
	 			id="selectInvestAndFdLikeAndFd">
		<result property="fdCode" column="fdCode"/>
		<result property="numberOfShares" column="numberOfShares"/>
		<result property="issuePrice" column="issuePrice"/>
		<result property="closeDate" column="closeDate"/>
		<result property="fdTitle" column="fdTitle"/>
		<result property="fdType" column="fdType"/>
		<result property="minInvestMoney" column="minInvestMoney"/>
		<result property="liketotal" column="liketotal"/>
		<result property="investtotal" column="investtotal"/>
		<result property="investcount" column="investcount"/>
		<result property="posterImg" column="posterImg"/>
	</resultMap>
	<!-- FundingDetail -->
	<resultMap type="com.pineapple.funding.service.Funding"
			   id="selectFundingDetail">
		<result property="fdDetailCode" column="fdDetailCode"/>
		<result property="openstory" column="openstory"/>
		<result property="comValue" column="comValue"/>
	</resultMap>
	 <!-- FundingQna -->
	 <resultMap type="com.pineapple.invest.service.FundingQna"
			   	id="selectFundingQna">
		<result property="qnaCode" column="qnaCode"/>
		<result property="qnaFdId" column="qnaFdId"/>
		<result property="qnaFdCode" column="qnaFdCode"/>
		<result property="qnaFdTitle" column="qnaFdTitle"/>
		<result property="qnaFdContent" column="qnaFdContent"/>
		<result property="qnaFdTime" column="qnaFdTime"/>
	</resultMap>
	<!-- FundingQnaReply -->
	<resultMap type="com.pineapple.invest.service.FundingQnaReply"
			   id="selectFundingQnaReply">
		<id property="qnaReCode" column="qnaReCode"/>
		<result property="reQnaCode" column="reQnaCode"/>
		<result property="qnaReId" column="qnaReId"/>
		<result property="qnaReContent" column="qnaReContent"/>
		<result property="qnaReTime" column="qnaReTime"/>
	</resultMap>
	<!-- FundingQnaAndQnaReply -->
	<resultMap type="com.pineapple.invest.service.FundingQnaAndQnaReply" 
			   id="selectFundingQnaAndQnaReplyresult">
		<id property="qnaReCode" column="qnaReCode"/>
		<result property="reQnaCode" column="reQnaCode"/>
		<result property="qnaReId" column="qnaReId"/>
		<result property="qnaReContent" column="qnaReContent"/>
		<result property="qnaReTime" column="qnaReTime"/>
		<result property="qnaFdCode" column="qnaFdCode"/>
	</resultMap>
	<!-- 투자하기 main 에서 사용하는 펀딩조건 검색 조회 쿼리 -->
	<select id="selectInvestFundingListChoose" parameterType="hashmap" resultMap="selectInvestAndFd">
		SELECT  f.fdCode,
				f.fdTitle,
				f.numberOfShares,
				c.comName,
				IFNULL((SELECT sum(si.purchaseShares) FROM investment si WHERE si.investFdCode = f.fdCode GROUP BY si.investFdCode),0) as total,
				f.posterImg,
				f.minInvestMoney,
				f.issuePrice,
				TO_DAYS(f.closeDate)-TO_DAYS(now()) as days,
				f.fdStatus
		FROM funding f 
		LEFT JOIN company c 
		ON f.fdComCode = c.comCode
		LEFT JOIN businessarea b
		ON f.fdCode = b.areaFdCode
		LEFT JOIN dividendplan d
		ON f.fdCode = d.divFdCode
		<where>
		(f.fdStatus = '모집중' OR f.fdStatus = '결제모집중')
		<if test="fundingtitlename != null">
			AND
			<foreach collection="fundingtitlename" item="title" open="(" close=")" separator="or">
				f.fdTitle LIKE CONCAT('%',#{title},'%')
			</foreach>
		</if>
		<if test="fdtype != null">
			AND
			<foreach collection="fdtype" item="type" open="(" close=")" separator="or">
				f.fdType = #{type}
			</foreach>
		</if>
		<if test="fdarea != null">
			AND 
			<foreach collection="fdarea" item="area" open="(" close=")" separator="or">
				b.areaName = #{area}
			</foreach>
		</if>
		<if test="fddividend != null">
			AND
			<foreach collection="fddividend" item="dividend" open="(" close=")" separator="or">
				<if test="dividend == 1">
					d.dividendRate &lt; 10
				</if>
				<if test="dividend == 2">
					d.dividendRate &gt;= 10 and d.dividendRate &lt; 15
				</if>
				<if test="dividend == 3">
					d.dividendRate &gt;= 15
				</if>
			</foreach>
		</if>
		</where>
		GROUP BY f.fdCode 
		ORDER BY f.fdDate DESC;
	</select>
	<!-- 투자하기 펀딩안에서 사용하는 모집중인 펀딩 조회 쿼리 -->
	<select id="selectInvestAndFdLikeAndFd" parameterType="INT" resultType="com.pineapple.invest.service.InvestAndFdLikeAndFd">
		SELECT f.fdCode,
			 f.numberOfShares, 
			 f.issuePrice,
			 f.closeDate,
			 f.fdTitle,
			 f.fdType,
			 f.minInvestMoney,
			 (SELECT COUNT(sfl.fdCode)FROM fundinglike sfl WHERE sfl.fdCode= #{fdCode}) as liketotal,
			 IFNULL(SUM(i.purchaseShares),0) as investtotal,
			 COUNT(i.investId) as investcount,
			 IFNULL(fd.openstory,'정보없음') as openstory,
			 IFNULL(fd.comValue,'정보없음') as comValue,
			 f.posterImg
		FROM funding f 
		LEFT JOIN investment i 
		ON f.fdCode = i.investFdCode 
		LEFT JOIN fundingdetail fd
		ON f.fdCode = fd.fdDetailCode
		WHERE f.fdCode = #{fdCode};
	</select>
	<!-- 하나의 펀딩의 Detail 정보(openstory,comValue) -->
	<select id="selectFundingDetail" parameterType="INT" resultType="com.pineapple.funding.service.FundingDetail">
		SELECT fd.fdDetailCode,
			   fd.openstory,
			   fd.comValue 
		FROM fundingdetail fd 
		WHERE fd.fdDetailCode = #{fdCode};
	</select>
	<!-- 펀딩 투자 예약하기 -->
	<insert id="insertInvestment">
		INSERT INTO investment
			   (investFdCode, investId, purchaseShares, investTime)
		VALUES (#{investFdCode}, #{investId}, #{purchaseShares}, NOW())
	</insert>
	<!-- 하나의 펀딩의 Q&A정보 -->
 	<select id="selectFundingQna" parameterType="INT" resultType="com.pineapple.invest.service.FundingQna">
		SELECT fq.qnaCode,
			   fq.qnaFdId,
			   fq.qnaFdCode,
			   fq.qnaFdTitle,
			   fq.qnaFdContent,
			   fq.qnaFdTime
		FROM fundingqna fq 
		WHERE fq.qnaFdCode = #{fdCode}
		ORDER BY fq.qnaFdTime DESC;
	</select>
	<!-- 하나의 펀딩 Q&A에 대한 댓글조회 -->
	<select id="selectFundingQnaAndQnaReply" parameterType="INT" resultMap="selectFundingQnaAndQnaReplyresult">
		SELECT fqr.qnaReCode,
			   fqr.reQnaCode,
			   fqr.qnaReId,
			   fqr.qnaReContent,
			   fqr.qnaReTime,
			   fq.qnaFdCode 
		FROM fundingqnareply fqr 
		LEFT JOIN fundingqna fq 
		ON fqr.reQnaCode = fq.qnaCode 
		WHERE reQnaCode = #{qnaCode}
		ORDER BY qnaReTime DESC
	</select>
	<!-- 하나의 펀딩 Q&A 입력하기 -->
 	<insert id="insertFundingQna" parameterType="com.pineapple.invest.service.FundingQna">
		INSERT INTO fundingqna
			   (qnaFdId, qnaFdCode, qnaFdTitle, qnaFdContent, qnaFdTime)
		VALUES (#{qnaFdId}, #{qnaFdCode}, #{qnaFdTitle}, #{qnaFdContent}, NOW())
	</insert>
	<!-- 하나의 펀딩 Q&A 수정하기 -->
	<update id="updateFundingQna" parameterType="com.pineapple.invest.service.FundingQna">
		UPDATE fundingqna
			SET
				qnaFdCode=#{qnaFdCode},
				qnaFdTitle=#{qnaFdTitle},
				qnaFdContent=#{qnaFdContent}
		WHERE qnaCode=#{qnaCode}
	</update>
	 <!-- 하나의 펀딩 Q&A 글 삭제시 댓글삭제 -->
	<delete id="deleteFundingQnaAllReply" parameterType="INT">
		DELETE FROM fundingqnareply WHERE reQnaCode=#{qnaCode}
	</delete>
	<!-- 하나의 펀딩 Q&A 삭제하기 -->
	<delete id="deleteFundingQna" parameterType="INT">
		DELETE FROM fundingqna WHERE qnaCode=#{qnaCode}
	</delete>
	<!-- 하나의 펀딩 Q&A 댓글 입력하기 -->
	<insert id="insertFundingQnaReply" parameterType="com.pineapple.invest.service.FundingQna">
		INSERT INTO fundingqnareply
			   (reQnaCode, qnaReId, qnaReContent, qnaReTime)
		VALUES (#{reQnaCode}, #{qnaReId}, #{qnaReContent}, NOW())
	</insert>
	<!-- 하나의 펀딩 Q&A 댓글 수정하기 -->
	<update id="updateFundingQnaReply">
		UPDATE fundingqnareply
			SET
				qnaReContent=#{qnaReContent}
		WHERE qnaReCode = #{qnaReCode}
	</update>
	<!-- 하나의 펀딩 Q&A 댓글 삭제하기 -->
	<delete id="deleteFundingQnaReply">
		DELETE FROM fundingqnareply WHERE qnaReCode=#{qnaReCode}
	</delete>
	
	
	
	
<!-- 	MY Page MY Page MY Page MY Page MY Page MY Page MY Page MY Page MY Page MY Page MY Page MY Page MY Page  -->
	<!-- MyInvestorFundingQna -->
	<resultMap type="com.pineapple.invest.service.MyInvestorFundingQna" 
			   id="selectMypageFundingQnaResultMap">
		<id property="qnaCode" column="qnaCode"/>
		<result property="qnaFdCode" column="qnaFdCode"/>
		<result property="qnaFdTitle" column="qnaFdTitle"/>
		<result property="qnaFdContent" column="qnaFdContent"/>
		<result property="qnaFdTime" column="qnaFdTime"/>
		<result property="comName" column="comName"/>
		<result property="fdTitle" column="fdTitle"/>
		<result property="fdType" column="fdType"/>
	</resultMap>
	<!-- InvestorInvestList -->
	<resultMap type="com.pineapple.invest.service.InvestorInvestList" id="selectInvestresultmap">
		<id property="investCode" column="investCode"/>
	 	<result property="investFdCode" column="investFdCode"/>
	 	<result property="investId" column="investId"/>
	 	<result property="investTime" column="investTime"/>
	 	<result property="payCheck" column="payCheck"/>
	 	<result property="purchaseShares" column="purchaseShares"/>
	 	<result property="fdCode" column="fdCode"/>
	 	<result property="fdType" column="fdType"/>
	 	<result property="fdStatus" column="fdStatus"/>
	 	<result property="investtotal" column="investtotal"/>	
</resultMap>
	<!-- 자신의 펀딩 Q&A 글 조회 -->
	<select id="selectMypageFundingQna" resultMap="selectMypageFundingQnaResultMap">
		SELECT fq.qnaCode,
			   fq.qnaFdCode,
			   fq.qnaFdTitle,
			   fq.qnaFdContent,
			   fq.qnaFdTime,
			   c.comName,
			   f.fdTitle,
			   f.fdType 
		FROM fundingqna fq 
		INNER JOIN funding f 
		ON fq.qnaFdCode = f.fdCode 
		INNER JOIN company c 
		ON c.comCode = f.fdComCode 
		WHERE fq.qnaFdId = #{qnaFdId} 
		ORDER BY fq.qnaFdTime DESC
	</select>
	<!-- 자신의 투자 list 조회 -->
	<select id="selectMpageinvestment" parameterType="String" resultMap="selectInvestresultmap">
		SELECT  i.investCode,
			i.investFdCode,
			i.investId,
			i.investTime,
			i.payCheck,
			i.purchaseShares,
			f.fdCode,
			f.fdType,
			f.fdStatus,
			f.numberOfShares,
			f.fdTitle,
			f.issuePrice,
			CASE f.fdStatus WHEN '모집중' THEN (SELECT SUM(si.purchaseShares) FROM investment si WHERE si.investFdCode = f.fdCode GROUP BY si.investFdCode ) WHEN '결제모집중' THEN (SELECT SUM(si.purchaseShares) FROM investment si WHERE si.investFdCode = f.fdCode AND si.payCheck = 1 GROUP BY si.investFdCode) WHEN '진행중' THEN (SELECT SUM(si.purchaseShares) FROM investment si WHERE si.investFdCode = f.fdCode GROUP BY si.investFdCode) END investtotal 
		FROM investment i 
		INNER JOIN funding f 
		ON i.investFdCode = f.fdCode  
		WHERE i.investId = #{id}
		GROUP BY i.investCode
	</select>
</mapper>