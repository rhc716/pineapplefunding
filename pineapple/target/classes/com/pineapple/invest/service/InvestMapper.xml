<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.pineapple.invest.service.InvestMapper">
	 <!-- InvestAndFd -->
	 <resultMap type="com.pineapple.invest.service.InvestAndFd"
	 			id="getInvestAndFd">
	 	<result property="fdCode" column="fdCode"/>
	 	<result property="fdTitle" column="fdTitle"/>
	 	<result property="numberOfShares" column="numberOfShares"/>
	 	<result property="comName" column="comName"/>
	 	<result property="total" column="total"/>
	 </resultMap>
	 <!-- InvestAndFdLikeAndFd -->
	 <resultMap type="com.pineapple.invest.service.InvestAndFdLikeAndFd"
	 			id="getInvestAndFdLikeAndFd">
		<result property="fdCode" column="fdCode"/>
		<result property="numberOfShares" column="numberOfShares"/>
		<result property="issuePrice" column="issuePrice"/>
		<result property="closeDate" column="closeDate"/>
		<result property="fdTitle" column="fdTitle"/>
		<result property="fdType" column="fdType"/>
		<result property="minInvestMoney" column="minInvestMoney"/>
		<result property="liketotal" column="liketotal"/>
		<result property="investtotal" column="investtotal"/>
		<result property="investcount" column="investcount"/>
	</resultMap>
	<!-- FundingDetail -->
	<resultMap type="com.pineapple.funding.service.Funding"
			   id="getFundingDetail">
		<result property="fdDetailCode" column="fdDetailCode"/>
		<result property="openstory" column="openstory"/>
		<result property="comValue" column="comValue"/>
	</resultMap>
	 <!-- FundingQna -->
	 <resultMap type="com.pineapple.invest.service.FundingQna"
			   	id="getFundingQna">
		<result property="qnaCode" column="qnaCode"/>
		<result property="qnaFdId" column="qnaFdId"/>
		<result property="qnaFdCode" column="qnaFdCode"/>
		<result property="qnaFdTitle" column="qnaFdTitle"/>
		<result property="qnaFdContent" column="qnaFdContent"/>
		<result property="qnaFdTime" column="qnaFdTime"/>
	</resultMap>
	<resultMap type="" id="">
		<result/>
		<result/>
		<result/>
		<result/>
		<result/>
	</resultMap>
	<!-- 투자하기 main 에서 사용하는 모집중인 펀딩 리스트 조회 쿼리 -->
	<select id="getInvestAndFd" parameterType="java.util.Map" resultType="com.pineapple.invest.service.InvestAndFd">
		SELECT  f.fdCode,
				f.fdTitle,
				f.numberOfShares,
				c.comName,
				IFNULL(sum(i.purchaseShares),0) as total
		FROM funding f 
		LEFT JOIN company c 
		ON f.fdComCode = c.comCode 
		LEFT JOIN investment i 
		ON f.fdCode = i.investFdCode 
		WHERE f.fdStatus = '모집중' 
		GROUP BY f.fdCode 
		ORDER BY f.openDate ASC;
	</select>
	<!-- 투자하기 main 에서 사용하는 모집중인 펀딩 리스트 조회 쿼리 -->
	<select id="getInvestAndFdLikeAndFd" parameterType="INT" resultType="com.pineapple.invest.service.InvestAndFdLikeAndFd">
		SELECT f.fdCode,
			 f.numberOfShares, 
			 f.issuePrice,
			 f.closeDate,
			 f.fdTitle,
			 f.fdType,
			 f.minInvestMoney,
			 (SELECT COUNT(sfl.fdCode)FROM fundinglike sfl WHERE sfl.fdCode= #{fdCode}) as liketotal,
			 IFNULL(SUM(i.purchaseShares),0) as investtotal,
			 COUNT(i.investId) as investcount,
			 IFNULL(fd.openstory,'정보없음') as openstory,
			 IFNULL(fd.comValue,'정보없음') as comValue
		FROM funding f 
		LEFT JOIN investment i 
		ON f.fdCode = i.investFdCode 
		LEFT JOIN fundingdetail fd
		ON f.fdCode = fd.fdDetailCode
		WHERE f.fdCode = #{fdCode};
	</select>
	<!-- 하나의 펀딩의 Detail 정보(openstory,comValue) -->
	<select id="getFundingDetail" parameterType="INT" resultType="com.pineapple.funding.service.FundingDetail">
		SELECT fd.fdDetailCode,
			   fd.openstory,
			   fd.comValue 
		FROM fundingdetail fd 
		WHERE fd.fdDetailCode = #{fdCode};
	</select>
	<!-- 하나의 펀딩의 Q&A정보 -->
 	<select id="getFundingQna" parameterType="INT" resultType="com.pineapple.invest.service.FundingQna">
		SELECT fq.qnaCode,
			   fq.qnaFdId,
			   fq.qnaFdCode,
			   fq.qnaFdTitle,
			   fq.qnaFdContent,
			   fq.qnaFdTime
		FROM fundingqna fq 
		WHERE fq.qnaFdCode = #{fdCode}
		ORDER BY fq.qnaFdTime DESC;
	</select>
</mapper>